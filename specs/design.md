## 2. Design Document (設計書)

### 2.1. システムアーキテクチャ

本アプリケーションはスタンドアロンのデスクトップアプリケーションであるため、**Model-View-Update (MVU) アーキテクチャ** を採用します。これは、状態(Model)・描画(View)・更新ロジック(Update)を明確に分離するパターンであり、Rustの軽量GUIライブラリ `egui` と非常に相性が良い設計です。

**アーキテクチャ図:**```
+-------------------------------------------------+
|                  User Interface (View)          |
|  (eframe/egui: ウィンドウ、ボタン、カレンダーグリッド)  |
+----------------------^--------------------------+
                       | (描画)
                       |
+----------------------+--------------------------+
|                  Application State (Model)      |
|  - 表示中の年月 (current_month: (i32, u32))     |
|  - マークされた日付 (marked_dates: HashSet)     |
|  - 最前面表示フラグ (is_always_on_top: bool)    |
+----------------------|--------------------------+
                       | (更新)
                       |
+----------------------v--------------------------+
|                  Update Logic                   |
| (ユーザー入力やイベントに応じてStateを更新)         |
|  - 月移動処理                                   |
|  - 日付クリック処理                             |
|  - ピン留め処理                                 |
+----------------------|--------------------------+
                       | (永続化/読み込み)
                       |
+----------------------v--------------------------+
|                  Persistence Layer              |
|   (serde_json: 設定ファイルをJSON形式で読み書き)   |
+-------------------------------------------------+
```

**選定理由:**
MVUパターンは、UIの状態変化を一方通行のデータフローで管理するため、状態がどこでどのように変更されたかを追跡しやすく、デバッグや機能追加が容易になります。`egui`はこのパターンをネイティブにサポートしており、軽量かつ高速なGUIを少ないコード量で実現できるため、本プロジェクトの「軽量」という要件に完全に合致しています。

### 2.2. コンポーネント分割

| コンポーネント | 責務 |
| :--- | :--- |
| **`main.rs`** | アプリケーションのエントリーポイント。`eframe`を初期化し、`AppState`の初期読み込みを行い、メインループを開始する。 |
| **`app.rs` (AppState)** | アプリケーション全体の **Model**。全ての状態（表示月、マークされた日付、ピン留め状態など）を保持する構造体。`eframe::App`トレイトを実装し、UpdateロジックとViewの描画処理を担う。 |
| **`ui/calendar_view.rs`** | 指定された1ヶ月分のカレンダーを描画する **View** コンポーネント。日付のグリッド、曜日ヘッダーの描画を担当する。 |
| **`ui/header_view.rs`** | 月移動ボタン、今日ボタン、ピン留めボタンを含むヘッダーを描画する **View** コンポーネント。 |
| **`logic/calendar_logic.rs`** | カレンダー計算ロジック。指定された年月から、その月の日付、曜日、前後の月の余日を含むグリッドデータを生成する責務を持つ。 |
| **`persistence.rs`** | **永続化層**。`AppState`内のマークされた日付をJSONファイルとして保存・読み込みする機能を提供する。 |

### 2.3. インターフェース定義

コンポーネント間の連携は、主に `app.rs` 内で行われます。

- **ユーザー操作 → Update Logic:**
  - `egui`のイベントループがボタンクリック（`if ui.button("...").clicked()`）やウィンドウイベントを検知する。
  - `app.rs` 内の `update` メソッドでこれらのイベントを処理し、`AppState` を変更する。
    - 例：月移動ボタンクリック → `AppState` の `current_month` を変更する。
    - 例：日付セルクリック → `AppState` の `marked_dates` に日付を追加/削除する。

- **AppState → View:**
  - `update` メソッドの描画部分で、現在の `AppState` を参照して `calendar_view` や `header_view` などのUIコンポーネントを呼び出す。
  - 各UIコンポーネントは、渡された状態に基づいてUIを描画する。

### 2.4. データモデル/スキーマ

**アプリケーション状態 (`AppState` in `app.rs`):**
```rust
use std::collections::HashSet;
use chrono::NaiveDate;

pub struct AppState {
    // 表示の中心となる年月
    pub current_month: (i32, u32), // (year, month)
    // 色付けされた日付の集合
    pub marked_dates: HashSet<NaiveDate>,
    // 最前面表示の状態
    pub is_always_on_top: bool,
}
```

**永続化データスキーマ (`config.json`):**
ユーザープロファイルディレクトリ (`%APPDATA%/FeatherCalendar/config.json`) に保存されるJSONファイルの形式。
```json
{
  "marked_dates": [
    "2024-08-15",
    "2024-09-01",
    "2024-09-22"
  ]
}
```

### 2.5. テスト戦略

- **ユニットテスト (`cargo test`):**
  - **対象:** `logic/calendar_logic.rs`
  - **内容:**
    - 特定の年月（うるう年を含む）に対して、正しい日数と開始曜日が計算できること。
    - 日曜始まりの週データが正しく生成されること。
- **統合テスト:**
  - **対象:** `persistence.rs`
  - **内容:**
    - `AppState`の一部（`marked_dates`）をファイルにシリアライズし、再度デシリアライズして復元できることを確認する。
- **E2E（エンドツーエンド）テスト/手動テスト:**
  - **内容:**
    1.  アプリケーションを起動し、3ヶ月カレンダーが表示されることを確認。
    2.  月移動ボタン、今日ボタンが期待通りに動作することを確認。
    3.  複数の日付をクリックして色付けし、アプリを再起動後も色が保持されていることを確認。
    4.  ピン留めボタンで最前面固定が切り替えられることを確認。
    5.  ウィンドウをリサイズし、レイアウトが追従することを確認。
    6.  Windows 10/11の両環境で上記テストを実施する。

### 2.6. 技術選定と理由

- **言語: Rust**
  - **理由:** ユーザー指定。パフォーマンス、メモリ安全性、単一実行ファイルの生成能力がデスクトップアプリ開発に最適。
- **GUIフレームワーク: `egui`**
  - **理由:** 軽量で依存関係が少なく、即時モードGUIの採用によりUIロジックをシンプルに記述できる。本プロジェクトの「軽量」「インストール不要」という要件に最も合致する。
- **ウィンドウ・イベント管理: `eframe`**
  - **理由:** `egui`の公式インテグレーション。ウィンドウの作成、GPUバックエンドのセットアップ、イベントループの管理を抽象化し、開発者がアプリケーションロジックに集中できるようにする。
- **日付・時刻処理: `chrono`**
  - **理由:** Rustにおける日付と時刻を扱うためのデファクトスタンダード。日付の計算やフォーマットが容易に行える。
- **シリアライズ/デシリアライズ: `serde` / `serde_json`**
  - **理由:** Rustの構造体とデータ形式（JSON）を相互に変換するための標準的なライブラリ。堅牢で高性能。設定ファイルの読み書きに不可欠。
